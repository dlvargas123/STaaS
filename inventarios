import os
import csv
import traceback
from datetime import datetime

# Directorio de entrada
input_directory = "/mnt/POOL-STORAGE/"

# Obtener la fecha actual y formatearla como YYYY-MM-DD
current_date = datetime.now().strftime("%Y-%m-%d")

# Archivo de salida basado en la fecha actual
output_file = f"/root/inventario_dlvargas/{current_date}_inventario.csv"  # Usa la ruta completa

# Archivo de log para errores
log_file = "/root/inventario_dlvargas/error.log"  # Usa la ruta completa

# Función para obtener la extensión de un archivo
def get_extension(filename):
    _, extension = os.path.splitext(filename)
    return extension[1:] if extension else ""

try:
    # Crear y escribir el archivo CSV
    with open(output_file, mode='w', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["Length", "Name", "Extension", "FullName"])

        # Recorrer todos los archivos y directorios en input_directory
        for root, dirs, files in os.walk(input_directory):
            for name in dirs + files:
                fullname = os.path.join(root, name)
                if os.path.isfile(fullname):
                    length = os.path.getsize(fullname)
                else:
                    length = 0
                extension = get_extension(name)
                writer.writerow([length, name, extension, fullname])
except Exception as e:
    with open(log_file, 'a') as log:
        log.write(f"Error: {e}\n")
        log.write(traceback.format_exc())
        log.write("\n")
